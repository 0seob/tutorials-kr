


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>(베타) LSTM 기반 단어 단위 언어 모델의 동적 양자화 &mdash; PyTorch Tutorials 1.6.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="(베타) BERT 모델 동적 양자화하기" href="../intermediate/dynamic_quantization_bert_tutorial.html" />
    <link rel="prev" title="가지치기 기법(Pruning) 튜토리얼" href="../intermediate/pruning_tutorial.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<body class="pytorch-body">
  <nav class="navbar sticky-top navbar-dark fixed-top navbar-expand-lg" style="background: rgba(55,55,55,.8)">
    <div class="container-fluid">
      <div class="navbar-brand">
        <a href="https://pytorch.kr/" aria-label="PyTorch">
          <img src="../_static/images/logo-kr.svg" width="260" height="28" fill="white" />
        </a>
      </div>
      <button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed" aria-expanded="false" aria-controls="nav-collapse"><span class="navbar-toggler-icon"></span></button>
      <div id="nav-collapse" class="navbar-collapse collapse">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a href="//pytorch.kr/" target="_self" class="nav-link">홈</a></li>
          <li class="nav-item">
            <a href="//tutorials.pytorch.kr/" target="_self" class="nav-link">튜토리얼</a>
          </li>
          <li class="nav-item">
            <a href="//pytorch.kr/about" target="_self" class="nav-link">
              소개
            </a></li>
        </ul>
      </div>
    </div>
  </nav>

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.6.0
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search Tutorials" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">파이토치(PyTorch) 레시피</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../recipes/recipes_index.html">모든 레시피 보기</a></li>
</ul>
<p class="caption"><span class="caption-text">파이토치(PyTorch) 배우기</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/deep_learning_60min_blitz.html">파이토치(PyTorch)로 딥러닝하기: 60분만에 끝장내기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/pytorch_with_examples.html">예제로 배우는 파이토치(PyTorch)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/nn_tutorial.html"><cite>torch.nn</cite> 이 <em>실제로</em> 무엇인가요?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/tensorboard_tutorial.html">TensorBoard로 모델, 데이터, 학습 시각화하기</a></li>
</ul>
<p class="caption"><span class="caption-text">이미지/비디오</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/torchvision_tutorial.html">TorchVision 객체 검출 미세조정(Finetuning) 튜토리얼</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/transfer_learning_tutorial.html">컴퓨터 비전(Vision)을 위한 전이학습(Transfer Learning)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/fgsm_tutorial.html">적대적 예제 생성(Adversarial Example Generation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/dcgan_faces_tutorial.html">DCGAN Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">오디오</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/audio_preprocessing_tutorial.html">torchaudio Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">텍스트</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/transformer_tutorial.html">nn.Transformer 와 TorchText 로 시퀀스-투-시퀀스(Sequence-to-Sequence) 모델링하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/char_rnn_classification_tutorial.html">기초부터 시작하는 NLP: 문자-단위 RNN으로 이름 분류하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/char_rnn_generation_tutorial.html">기초부터 시작하는 NLP:  문자-단위 RNN으로 이름 생성하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/seq2seq_translation_tutorial.html">기초부터 시작하는 NLP: Sequence to Sequence 네트워크와 Attention을 이용한 번역</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/text_sentiment_ngrams_tutorial.html">TorchText로 텍스트 분류하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/torchtext_translation_tutorial.html">TorchText로 언어 번역하기</a></li>
</ul>
<p class="caption"><span class="caption-text">강화학습</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/reinforcement_q_learning.html">강화 학습 (DQN) 튜토리얼</a></li>
</ul>
<p class="caption"><span class="caption-text">PyTorch 모델을 프로덕션 환경에 배포하기</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/flask_rest_api_tutorial.html">Flask를 이용하여 Python에서 PyTorch를 REST API로 배포하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/Intro_to_TorchScript_tutorial.html">TorchScript 소개</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_export.html">C++에서 TorchScript 모델 로딩하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="super_resolution_with_onnxruntime.html">(선택) PyTorch 모델을 ONNX으로 변환하고 ONNX 런타임에서 실행하기</a></li>
</ul>
<p class="caption"><span class="caption-text">프론트엔드 API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/named_tensor_tutorial.html">(prototype) Introduction to Named Tensors in PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/memory_format_tutorial.html">(실험용) PyTorch를 사용한 Channels Last Memory Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_frontend.html">Using the PyTorch C++ Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_extension.html">Custom C++ and CUDA Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="torch_script_custom_ops.html">Extending TorchScript with Custom C++ Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="torch_script_custom_classes.html">Extending TorchScript with Custom C++ Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="torch-script-parallelism.html">Dynamic Parallelism in TorchScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="cpp_autograd.html">Autograd in C++ Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="dispatcher.html">Dispatcher in C++</a></li>
</ul>
<p class="caption"><span class="caption-text">모델 최적화</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intermediate/pruning_tutorial.html">가지치기 기법(Pruning) 튜토리얼</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">(베타) LSTM 기반 단어 단위 언어 모델의 동적 양자화</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/dynamic_quantization_bert_tutorial.html">(베타) BERT 모델 동적 양자화하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="static_quantization_tutorial.html">(beta) Static Quantization with Eager Mode in PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/quantized_transfer_learning_tutorial.html">(beta) 컴퓨터 비전(Vision) 튜토리얼을 위한 양자화된 전이학습(Quantized Transfer Learning)</a></li>
</ul>
<p class="caption"><span class="caption-text">병렬 및 분산 학습</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../beginner/dist_overview.html">PyTorch Distributed Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/model_parallel_tutorial.html">단일 머신을 이용한 모델 병렬화 실습 예제</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/ddp_tutorial.html">Getting Started with Distributed Data Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/dist_tuto.html">PyTorch로 분산 어플리케이션 개발하기</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/rpc_tutorial.html">Getting Started with Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../beginner/aws_distributed_training_tutorial.html">(advanced) PyTorch 1.0 Distributed Trainer with Amazon AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/rpc_param_server_tutorial.html">Implementing a Parameter Server Using Distributed RPC Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/dist_pipeline_parallel_tutorial.html">Distributed Pipeline Parallelism Using RPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intermediate/rpc_async_execution.html">Implementing Batch RPC Processing Using Asynchronous Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpc_ddp_tutorial.html">Combining Distributed DataParallel with Distributed RPC Framework</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../index.html">
          
            Tutorials
          
        </a> &gt;
      </li>

        
      <li>(베타) LSTM 기반 단어 단위 언어 모델의 동적 양자화</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="../_sources/advanced/dynamic_quantization_tutorial.rst.txt" rel="nofollow"><img src="../_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <div class="pytorch-call-to-action-links">
            <div id="tutorial-type">advanced/dynamic_quantization_tutorial</div>

            <div id="google-colab-link">
              <img class="call-to-action-img" src="../_static/images/pytorch-colab.svg"/>
              <div class="call-to-action-desktop-view">Run in Google Colab</div>
              <div class="call-to-action-mobile-view">Colab</div>
            </div>
            <div id="download-notebook-link">
              <img class="call-to-action-notebook-img" src="../_static/images/pytorch-download.svg"/>
              <div class="call-to-action-desktop-view">Download Notebook</div>
              <div class="call-to-action-mobile-view">Notebook</div>
            </div>
            <div id="github-view-link">
              <img class="call-to-action-img" src="../_static/images/pytorch-github.svg"/>
              <div class="call-to-action-desktop-view">View on GitHub</div>
              <div class="call-to-action-mobile-view">GitHub</div>
            </div>
          </div>

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-advanced-dynamic-quantization-tutorial-py"><span class="std std-ref">here</span></a> to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="lstm">
<span id="sphx-glr-advanced-dynamic-quantization-tutorial-py"></span><h1>(베타) LSTM 기반 단어 단위 언어 모델의 동적 양자화<a class="headerlink" href="#lstm" title="Permalink to this headline">¶</a></h1>
<p><strong>Author</strong>: <a class="reference external" href="https://github.com/jamesr66a">James Reed</a></p>
<p><strong>Edited by</strong>: <a class="reference external" href="https://github.com/SethHWeidman/">Seth Weidman</a></p>
<p><strong>번역</strong>: <a class="reference external" href="https://github.com/kypark7/">박경림</a> <a class="reference external" href="https://github.com/kwonmha/">Myungha Kwon</a></p>
<div class="section" id="id2">
<h2>시작하기<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>양자화는 모델의 크기를 줄이고 추론 속도를 높이면서도 정확도는 별로 낮아지지 않도록,
모델의 가중치와 활성 함수를 실수형에서 정수형으로 변환합니다.</p>
<p>이 튜토리얼에서는 PyTorch의 <a class="reference external" href="https://github.com/pytorch/examples/tree/master/word_language_model">단어 단위 언어 모델</a>
예제를 따라하면서, LSTM 기반의 단어 예측 모델에 가장 간단한 양자화 기법인
<a class="reference external" href="https://pytorch.org/docs/stable/quantization.html#torch.quantization.quantize_dynamic">동적 양자화</a>
를 적용해 보겠습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 불러오기</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>1. 모델 정의하기<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>단어 단위 언어 모델 예제에서 사용된 <a class="reference external" href="https://github.com/pytorch/examples/blob/master/word_language_model/model.py">모델</a> 을
따라 LSTM 모델 아키텍처를 정의합니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LSTMModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;인코더, 반복 모듈 및 디코더가 있는 컨테이너 모듈.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntoken</span><span class="p">,</span> <span class="n">ninp</span><span class="p">,</span> <span class="n">nhid</span><span class="p">,</span> <span class="n">nlayers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSTMModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">ntoken</span><span class="p">,</span> <span class="n">ninp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">ninp</span><span class="p">,</span> <span class="n">nhid</span><span class="p">,</span> <span class="n">nlayers</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nhid</span><span class="p">,</span> <span class="n">ntoken</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_weights</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span> <span class="o">=</span> <span class="n">nhid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">=</span> <span class="n">nlayers</span>

    <span class="k">def</span> <span class="nf">init_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">initrange</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">initrange</span><span class="p">,</span> <span class="n">initrange</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="n">initrange</span><span class="p">,</span> <span class="n">initrange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded</span><span class="p">,</span> <span class="n">hidden</span>

    <span class="k">def</span> <span class="nf">init_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bsz</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span><span class="p">),</span>
                <span class="n">weight</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlayers</span><span class="p">,</span> <span class="n">bsz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>2. 텍스트 데이터 불러오기<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>다음으로, 단어 단위 언어 모델 예제의 <a class="reference external" href="https://github.com/pytorch/examples/blob/master/word_language_model/data.py">전처리</a>
과정을 따라 <a class="reference external" href="https://www.google.com/search?q=wikitext+2+data">Wikitext-2 데이터셋</a> 을 <cite>Corpus</cite> 인스턴스에 불러옵니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Dictionary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word2idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx2word</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx2word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word2idx</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2word</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2idx</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2word</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Corpus</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;train.txt&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;valid.txt&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;test.txt&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;텍스트 파일 토큰화&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># 사전에 단어 추가</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">add_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

        <span class="c1"># 파일 내용 토큰화</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">idss</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">]</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">word2idx</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>
                <span class="n">idss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">idss</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ids</span>

<span class="n">model_data_filepath</span> <span class="o">=</span> <span class="s1">&#39;data/&#39;</span>

<span class="n">corpus</span> <span class="o">=</span> <span class="n">Corpus</span><span class="p">(</span><span class="n">model_data_filepath</span> <span class="o">+</span> <span class="s1">&#39;wikitext-2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>3. 사전 학습된 모델 불러오기<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>이 튜토리얼은 모델이 학습된 후 적용되는 양자화 기술인 동적 양자화에 대한 튜토리얼입니다.
따라서 우리는 미리 학습된 가중치를 모델 아키텍처에 로드할 것 입니다. 이 가중치는 word
language 모델 예제의 기본 설정을 사용하여 5개의 epoch 동안 학습하여 얻은 것입니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ntokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LSTMModel</span><span class="p">(</span>
    <span class="n">ntoken</span> <span class="o">=</span> <span class="n">ntokens</span><span class="p">,</span>
    <span class="n">ninp</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
    <span class="n">nhid</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">nlayers</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="n">model_data_filepath</span> <span class="o">+</span> <span class="s1">&#39;word_language_model_quantize.pth&#39;</span><span class="p">,</span>
        <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>LSTMModel(
  (drop): Dropout(p=0.5, inplace=False)
  (encoder): Embedding(33278, 512)
  (rnn): LSTM(512, 256, num_layers=5, dropout=0.5)
  (decoder): Linear(in_features=256, out_features=33278, bias=True)
)
</pre></div>
</div>
<p>이제 사전 학습된 모델이 잘 동작하는지 확인해보기 위해 텍스트를 생성해 보겠습니다.
지금까지 튜토리얼을 진행했던 방식처럼 <a class="reference external" href="https://github.com/pytorch/examples/blob/master/word_language_model/generate.py">이 예제</a> 를 따라 하겠습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">input_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">ntokens</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
<span class="n">hidden</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">init_hidden</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">num_words</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_data_filepath</span> <span class="o">+</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>  <span class="c1"># 기록을 추적하지 않습니다.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_words</span><span class="p">):</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
            <span class="n">word_weights</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">word_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">word_weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">input_</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">word_idx</span><span class="p">)</span>

            <span class="n">word</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">idx2word</span><span class="p">[</span><span class="n">word_idx</span><span class="p">]</span>

            <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">19</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Generated </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> words&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_data_filepath</span> <span class="o">+</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
    <span class="n">all_output</span> <span class="o">=</span> <span class="n">outf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">all_output</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>| Generated 0/1000 words
| Generated 100/1000 words
| Generated 200/1000 words
| Generated 300/1000 words
| Generated 400/1000 words
| Generated 500/1000 words
| Generated 600/1000 words
| Generated 700/1000 words
| Generated 800/1000 words
| Generated 900/1000 words
b&#39;in&#39; b&#39;the&#39; b&#39;Corrientes&#39; b&#39;@-@&#39; b&#39;up&#39; b&#39;with&#39; b&#39;Children&#39; b&#39;Sussex&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;Local&#39; b&#39;studies&#39; b&#39;who&#39; b&#39;for&#39; b&#39;a&#39; b&#39;small&#39; b&#39;detachment&#39; b&#39;,&#39; b&#39;Sports&#39; b&#39;,&#39;
b&#39;and&#39; b&#39;under&#39; b&#39;Argentina&#39; b&#39;,&#39; b&#39;dismantled&#39; b&#39;trees&#39; b&#39;and&#39; b&#39;dramaturgical&#39; b&#39;access&#39; b&#39;to&#39; b&#39;its&#39; b&#39;repression&#39; b&#39;by&#39; b&#39;his&#39; b&#39;narratives&#39; b&#39;\xe2\x80\x94&#39; b&#39;Vice&#39; b&#39;Oswald&#39; b&#39;,&#39; b&#39;a&#39;
b&#39;citizen&#39; b&#39;,&#39; b&#39;also&#39; b&#39;accelerated&#39; b&#39;ki&#39; b&#39;,&#39; b&#39;and&#39; b&#39;in&#39; b&#39;what&#39; b&#39;I&#39; b&#39;closed&#39; b&#39;to&#39; b&#39;portray&#39; b&#39;all&#39; b&#39;stories&#39; b&#39;during&#39; b&#39;this&#39; b&#39;first&#39; b&#39;breakdown&#39; b&#39;.&#39;
b&#39;James&#39; b&#39;sac&#39; b&#39;Mavis&#39; b&#39;Oaks&#39; b&#39;had&#39; b&#39;speculated&#39; b&#39;the&#39; b&#39;game&#39; b&quot;&#39;s&quot; b&#39;body&#39; b&#39;about&#39; b&#39;the&#39; b&#39;erroneous&#39; b&#39;crowds&#39; b&#39;.&#39; b&#39;The&#39; b&#39;race&#39; b&#39;on&#39; b&#39;the&#39; b&#39;bird&#39;
b&#39;usually&#39; b&#39;refused&#39; b&#39;to&#39; b&#39;rebuild&#39; b&#39;their&#39; b&#39;car&#39; b&#39;at&#39; b&#39;a&#39; b&#39;time&#39; b&#39;on&#39; b&#39;28&#39; b&#39;.&#39; b&#39;This&#39; b&#39;account&#39; b&#39;consisted&#39; b&#39;of&#39; b&#39;one&#39; b&#39;exchange&#39; b&#39;replaced&#39; b&#39;for&#39;
b&#39;short&#39; b&#39;businesses&#39; b&#39;,&#39; b&#39;with&#39; b&#39;assistance&#39; b&#39;to&#39; b&#39;their&#39; b&#39;reading&#39; b&#39;for&#39; b&#39;68&#39; b&#39;%&#39; b&#39;ranging&#39; b&#39;away&#39; b&#39;.&#39; b&#39;The&#39; b&#39;lengthy&#39; b&#39;jump&#39; b&#39;has&#39; b&#39;been&#39; b&#39;able&#39;
b&#39;to&#39; b&#39;continue&#39; b&#39;to&#39; b&#39;weaken&#39; b&#39;glamour&#39; b&#39;,&#39; b&#39;because&#39; b&#39;they&#39; b&#39;arrived&#39; b&#39;to&#39; b&#39;pass&#39; b&#39;playing&#39; b&#39;greater&#39; b&#39;foundation&#39; b&#39;features&#39; b&#39;to&#39; b&#39;better&#39; b&#39;speak&#39; b&#39;.&#39; b&#39;One&#39;
b&#39;O&#39; b&quot;&#39;t&quot; b&#39;be&#39; b&#39;Perugia&#39; b&#39;to&#39; b&#39;fulfill&#39; b&#39;from&#39; b&#39;the&#39; b&#39;handicap&#39; b&#39;.&#39; b&#39;It&#39; b&#39;was&#39; b&#39;further&#39; b&#39;by&#39; b&#39;Omar&#39; b&quot;&#39;&quot; b&#39;surface&#39; b&#39;relationships&#39; b&#39;\xe2\x80\x94&#39; b&#39;Routes&#39;
b&#39;Park&#39; b&#39;and&#39; b&#39;the&#39; b&#39;exception&#39; b&#39;of&#39; b&#39;primary&#39; b&#39;Americans&#39; b&#39;.&#39; b&#39;The&#39; b&#39;Penn&#39; b&#39;Police&#39; b&#39;Obo&#39; b&#39;culture&#39; b&#39;became&#39; b&#39;woodwork&#39; b&#39;were&#39; b&#39;so&#39; b&#39;preventing&#39; b&#39;Douglas&#39; b&#39;.&#39;
b&#39;&lt;eos&gt;&#39; b&#39;NASA&#39; b&quot;&#39;s&quot; b&#39;&lt;unk&gt;&#39; b&#39;was&#39; b&#39;challenged&#39; b&#39;closing&#39; b&#39;by&#39; b&#39;&lt;unk&gt;&#39; b&#39;&lt;unk&gt;&#39; b&#39;Mama&#39; b&#39;.&#39; b&#39;It&#39; b&#39;also&#39; b&#39;moved&#39; b&#39;a&#39; b&#39;replica&#39; b&#39;unknown&#39; b&#39;.&#39; b&#39;That&#39;
b&#39;shop&#39; b&#39;1882&#39; b&#39;,&#39; b&#39;Da&#39; b&#39;Harris&#39; b&#39;,&#39; b&#39;in&#39; b&#39;the&#39; b&#39;1989&#39; b&#39;election&#39; b&#39;,&#39; b&#39;was&#39; b&#39;thought&#39; b&#39;to&#39; b&#39;be&#39; b&#39;broadcast&#39; b&#39;by&#39; b&#39;The&#39; b&#39;planet&#39; b&#39;to&#39;
b&#39;funds&#39; b&#39;.&#39; b&#39;Carlos&#39; b&#39;Mayer&#39; b&#39;Commodore&#39; b&#39;acted&#39; b&#39;as&#39; b&#39;one&#39; b&#39;of&#39; b&#39;the&#39; b&#39;sponsorship&#39; b&#39;19&#39; b&#39;%&#39; b&#39;for&#39; b&#39;the&#39; b&#39;&lt;unk&gt;&#39; b&#39;race&#39; b&#39;in&#39; b&#39;the&#39; b&#39;final&#39;
b&#39;story&#39; b&#39;.&#39; b&#39;He&#39; b&#39;seems&#39; b&#39;to&#39; b&#39;continue&#39; b&#39;to&#39; b&#39;inspect&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;The&#39; b&#39;election&#39; b&#39;spread&#39; b&#39;to&#39; b&#39;the&#39; b&#39;law&#39; b&#39;to&#39; b&#39;disrupt&#39; b&#39;the&#39; b&#39;Jews&#39;
b&#39;in&#39; b&#39;1932&#39; b&#39;.&#39; b&#39;Hence&#39; b&#39;,&#39; b&#39;on&#39; b&#39;August&#39; b&#39;27&#39; b&#39;,&#39; b&#39;2006&#39; b&#39;,&#39; b&#39;the&#39; b&#39;Bureau&#39; b&#39;tried&#39; b&#39;to&#39; b&#39;be&#39; b&#39;reported&#39; b&#39;to&#39; b&#39;be&#39; b&#39;defeated&#39;
b&#39;@-@&#39; b&#39;cavern&#39; b&#39;to&#39; b&#39;ensure&#39; b&#39;.&#39; b&#39;The&#39; b&#39;indecency&#39; b&#39;Hockey&#39; b&#39;antibiotics&#39; b&#39;progressed&#39; b&#39;to&#39; b&#39;four&#39; b&#39;weeks&#39; b&#39;after&#39; b&#39;another&#39; b&#39;significant&#39; b&#39;unit&#39; b&#39;works&#39; b&#39;more&#39; b&#39;than&#39;
b&#39;apartment&#39; b&#39;Hesler&#39; b&#39;loss&#39; b&#39;.&#39; b&#39;Anime&#39; b&#39;@-@&#39; b&#39;labor&#39; b&#39;term&#39; b&#39;prepared&#39; b&#39;Benigno&#39; b&#39;runs&#39; b&#39;to&#39; b&#39;lining&#39; b&#39;,&#39; b&#39;in&#39; b&#39;1994&#39; b&#39;.&#39; b&#39;Eguchi&#39; b&#39;also&#39; b&#39;funded&#39;
b&#39;$&#39; b&#39;700&#39; b&#39;@,@&#39; b&#39;000&#39; b&#39;yards&#39; b&#39;.&#39; b&#39;Those&#39; b&#39;president&#39; b&#39;,&#39; b&#39;as&#39; b&#39;the&#39; b&#39;actor&#39; b&#39;&lt;unk&gt;&#39; b&#39;opportunities&#39; b&#39;for&#39; b&#39;a&#39; b&#39;272nd&#39; b&#39;owned&#39; b&#39;in&#39; b&#39;endorsement&#39;
b&#39;,&#39; b&#39;before&#39; b&#39;Wiesbaden&#39; b&#39;served&#39; b&#39;as&#39; b&#39;Raffles&#39; b&#39;Field&#39; b&#39;,&#39; b&#39;Bridgestone&#39; b&#39;Island&#39; b&#39;,&#39; b&#39;on&#39; b&#39;December&#39; b&#39;10&#39; b&#39;,&#39; b&#39;2011&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39;
b&#39;=&#39; b&#39;Hornung&#39; b&quot;&#39;s&quot; b&#39;Banksia&#39; b&#39;fairy&#39; b&#39;lamps&#39; b&#39;(&#39; b&#39;2010&#39; b&#39;)&#39; b&#39;=&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;The&#39; b&#39;Family&#39; b&#39;Race&#39; b&#39;,&#39; b&#39;Tower&#39; b&#39;utilizes&#39; b&#39;the&#39; b&#39;&lt;unk&gt;&#39;
b&#39;of&#39; b&#39;northern&#39; b&#39;Fantasy&#39; b&#39;Contactmusic.com&#39; b&#39;(&#39; b&#39;1819&#39; b&#39;)&#39; b&#39;;&#39; b&#39;Ceres&#39; b&#39;,&#39; b&#39;&lt;unk&gt;&#39; b&#39;(&#39; b&#39;&lt;unk&gt;&#39; b&#39;,&#39; b&#39;colored&#39; b&#39;)&#39; b&#39;.&#39; b&#39;They&#39; b&#39;Manas&#39; b&#39;(&#39;
b&#39;width&#39; b&#39;wrote&#39; b&#39;)&#39; b&#39;near&#39; b&#39;a&#39; b&#39;variety&#39; b&#39;of&#39; b&#39;review&#39; b&#39;,&#39; b&#39;particularly&#39; b&#39;0&#39; b&#39;\xe2\x80\x93&#39; b&#39;3&#39; b&#39;(&#39; b&#39;43&#39; b&#39;cm&#39; b&#39;)&#39; b&#39;jubilee&#39; b&#39;.&#39; b&#39;Up&#39;
b&#39;into&#39; b&#39;the&#39; b&#39;Vice&#39; b&#39;Republic&#39; b&#39;modeling&#39; b&#39;or&#39; b&#39;an&#39; b&#39;Haitian&#39; b&#39;account&#39; b&#39;than&#39; b&#39;600&#39; b&#39;meters&#39; b&#39;vessels&#39; b&#39;in&#39; b&#39;&lt;unk&gt;&#39; b&#39;.&#39; b&#39;There&#39; b&#39;were&#39; b&#39;nine&#39; b&#39;baritone&#39;
b&#39;re&#39; b&#39;@-@&#39; b&#39;platform&#39; b&#39;@-@&#39; b&#39;pounders&#39; b&#39;and&#39; b&#39;identifies&#39; b&#39;an&#39; b&#39;series&#39; b&#39;of&#39; b&#39;concrete&#39; b&#39;in&#39; b&#39;the&#39; b&#39;lakes&#39; b&#39;,&#39; b&#39;which&#39; b&#39;can&#39; b&#39;be&#39; b&#39;deputy&#39; b&#39;,&#39;
b&#39;even&#39; b&#39;one&#39; b&#39;&lt;unk&gt;&#39; b&#39;that&#39; b&#39;transit&#39; b&#39;other&#39; b&#39;.&#39; b&#39;spores&#39; b&#39;were&#39; b&#39;usually&#39; b&#39;besieged&#39; b&#39;,&#39; b&#39;causing&#39; b&#39;special&#39; b&#39;more&#39; b&#39;heavy&#39; b&#39;honors&#39; b&#39;them&#39; b&#39;,&#39; b&#39;and&#39;
b&#39;became&#39; b&#39;the&#39; b&#39;most&#39; b&#39;handsome&#39; b&#39;battleship&#39; b&#39;seen&#39; b&#39;by&#39; b&#39;being&#39; b&#39;the&#39; b&#39;first&#39; b&#39;war&#39; b&#39;in&#39; b&#39;central&#39; b&#39;Ireland&#39; b&#39;.&#39; b&#39;defines&#39; b&#39;six&#39; b&#39;spiders&#39; b&#39;to&#39; b&#39;do&#39;
b&#39;a&#39; b&#39;third&#39; b&#39;to&#39; b&#39;house&#39; b&#39;districts&#39; b&#39;,&#39; b&#39;Ceres&#39; b&#39;both&#39; b&#39;range&#39; b&#39;,&#39; b&#39;to&#39; b&#39;each&#39; b&#39;remaining&#39; b&#39;night&#39; b&#39;,&#39; b&#39;except&#39; b&#39;more&#39; b&#39;than&#39; b&#39;5&#39; b&#39;,&#39;
b&#39;opening&#39; b&#39;up&#39; b&#39;and&#39; b&#39;Synthesis&#39; b&#39;,&#39; b&#39;or&#39; b&#39;against&#39; b&#39;&lt;unk&gt;&#39; b&#39;,&#39; b&#39;foliage&#39; b&#39;and&#39; b&#39;torpedo&#39; b&#39;cloud&#39; b&#39;soil&#39; b&#39;.&#39; b&#39;Ceres&#39; b&#39;in&#39; b&#39;the&#39; b&#39;Greek&#39; b&#39;&lt;unk&gt;&#39;
b&#39;classification&#39; b&#39;was&#39; b&#39;visible&#39; b&#39;on&#39; b&#39;4&#39; b&#39;August&#39; b&#39;1885&#39; b&#39;against&#39; b&#39;Winston&#39; b&#39;B.&#39; b&#39;Colletts&#39; b&#39;sight&#39; b&#39;,&#39; b&#39;a&#39; b&#39;reminder&#39; b&#39;of&#39; b&#39;75&#39; b&#39;years&#39; b&#39;later&#39; b&#39;when&#39;
b&#39;Ceres&#39; b&#39;choose&#39; b&#39;with&#39; b&#39;increased&#39; b&#39;natural&#39; b&#39;communities&#39; b&#39;were&#39; b&#39;confusing&#39; b&#39;so&#39; b&#39;special&#39; b&#39;inflicted&#39; b&#39;posterior&#39; b&#39;bruising&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;A&#39; b&#39;collaboration&#39; b&#39;from&#39; b&#39;M.&#39; b&#39;Dreamers&#39;
b&#39;has&#39; b&#39;withdrawn&#39; b&#39;as&#39; b&#39;&quot;&#39; b&#39;power&#39; b&#39;&quot;&#39; b&#39;(&#39; b&#39;106&#39; b&#39;%&#39; b&#39;)&#39; b&#39;of&#39; b&#39;58&#39; b&#39;%&#39; b&#39;of&#39; b&#39;flora&#39; b&#39;;&#39; b&#39;this&#39; b&#39;was&#39; b&#39;later&#39; b&#39;Type&#39;
b&#39;over&#39; b&#39;to&#39; b&#39;remorse&#39; b&#39;in&#39; b&#39;Utah&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;=&#39; b&#39;=&#39; b&#39;Behaviour&#39; b&#39;=&#39; b&#39;=&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;The&#39; b&#39;common&#39; b&#39;starling&#39; b&#39;from&#39; b&#39;these&#39;
b&#39;points&#39; b&#39;appear&#39; b&#39;into&#39; b&#39;Israel&#39; b&#39;and&#39; b&#39;is&#39; b&#39;derived&#39; b&#39;to&#39; b&#39;a&#39; b&#39;prominent&#39; b&#39;population&#39; b&#39;from&#39; b&#39;waves&#39; b&#39;from&#39; b&#39;Portis&#39; b&#39;cap&#39; b&#39;along&#39; b&#39;by&#39; b&#39;kakapo&#39; b&#39;,&#39;
b&#39;government&#39; b&#39;,&#39; b&#39;spear&#39; b&#39;and&#39; b&#39;observatories&#39; b&#39;.&#39; b&#39;They&#39; b&#39;from&#39; b&#39;this&#39; b&#39;demos&#39; b&#39;proceed&#39; b&#39;about&#39; b&#39;3&#39; b&#39;@.@&#39; b&#39;4&#39; b&#39;@-@&#39; b&#39;cent&#39; b&#39;across&#39; b&#39;a&#39; b&#39;old&#39;
b&#39;season&#39; b&#39;as&#39; b&#39;when&#39; b&#39;it&#39; b&#39;appears&#39; b&#39;,&#39; b&#39;and&#39; b&#39;well&#39; b&#39;mainly&#39; b&#39;,&#39; b&#39;when&#39; b&#39;it&#39; b&#39;has&#39; b&#39;two&#39; b&#39;or&#39; b&#39;distinct&#39; b&#39;structures&#39; b&#39;that&#39; b&#39;may&#39; b&#39;be&#39;
b&#39;brought&#39; b&#39;to&#39; b&#39;express&#39; b&#39;the&#39; b&#39;thickness&#39; b&#39;for&#39; b&#39;villa&#39; b&#39;.&#39; b&#39;equal&#39; b&#39;immediately&#39; b&#39;up&#39; b&#39;in&#39; b&#39;areas&#39; b&#39;,&#39; b&#39;it&#39; b&#39;is&#39; b&#39;larger&#39; b&#39;,&#39; b&#39;Ralph&#39; b&#39;discomfort&#39;
b&#39;,&#39; b&#39;war&#39; b&#39;,&#39; b&#39;spored&#39; b&#39;,&#39; b&#39;ministers&#39; b&#39;,&#39; b&#39;peat&#39; b&#39;,&#39; b&#39;Nguy\xe1\xbb\x85n&#39; b&#39;,&#39; b&#39;and&#39; b&#39;Christina&#39; b&#39;indicating&#39; b&#39;southwestward&#39; b&#39;for&#39; b&#39;calculation&#39; b&#39;and&#39; b&#39;lower&#39; b&#39;birds&#39;
b&#39;and&#39; b&#39;found&#39; b&#39;non&#39; b&#39;@-@&#39; b&#39;transcriptional&#39; b&#39;institutions&#39; b&#39;.&#39; b&#39;In&#39; b&#39;areas&#39; b&#39;like&#39; b&#39;this&#39; b&#39;,&#39; b&#39;since&#39; b&#39;to&#39; b&#39;spread&#39; b&#39;that&#39; b&#39;these&#39; b&#39;are&#39; b&#39;Ferry&#39; b&#39;&lt;unk&gt;&#39;
b&#39;,&#39; b&#39;covers&#39; b&#39;may&#39; b&#39;be&#39; b&#39;seen&#39; b&#39;within&#39; b&#39;2006&#39; b&#39;when&#39; b&#39;these&#39; b&#39;species&#39; b&#39;do&#39; b&#39;not&#39; b&#39;occur&#39; b&#39;,&#39; b&#39;or&#39; b&#39;mid&#39; b&#39;@-@&#39; b&#39;kilogram&#39; b&#39;to&#39; b&#39;have&#39;
b&#39;few&#39; b&#39;stone&#39; b&#39;predators&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;In&#39; b&#39;moral&#39; b&#39;,&#39; b&#39;livestock&#39; b&#39;or&#39; b&#39;gold&#39; b&#39;patterns&#39; b&#39;may&#39; b&#39;be&#39; b&#39;seen&#39; b&#39;for&#39; b&#39;small&#39; b&#39;common&#39; b&#39;country&#39; b&#39;dating&#39;
b&#39;and&#39; b&#39;account&#39; b&#39;,&#39; b&#39;as&#39; b&#39;this&#39; b&#39;process&#39; b&#39;is&#39; b&#39;still&#39; b&#39;very&#39; b&#39;dark&#39; b&#39;noted&#39; b&#39;.&#39; b&#39;As&#39; b&#39;removed&#39; b&#39;range&#39; b&#39;,&#39; b&#39;it&#39; b&#39;is&#39; b&#39;still&#39; b&#39;far&#39;
b&#39;to&#39; b&#39;engage&#39; b&#39;in&#39; b&#39;human&#39; b&#39;planets&#39; b&#39;.&#39; b&#39;&lt;unk&gt;&#39; b&#39;rabbits&#39; b&#39;ensure&#39; b&#39;that&#39; b&#39;their&#39; b&#39;bird&#39; b&#39;literate&#39; b&#39;history&#39; b&#39;are&#39; b&#39;undergoing&#39; b&#39;Western&#39; b&#39;years&#39; b&#39;by&#39; b&#39;means&#39;
b&#39;they&#39; b&#39;have&#39; b&#39;.&#39; b&#39;That&#39; b&#39;may&#39; b&#39;be&#39; b&#39;uploaded&#39; b&#39;every&#39; b&#39;appearance&#39; b&#39;regarding&#39; b&#39;these&#39; b&#39;holes&#39; b&#39;are&#39; b&#39;imminent&#39; b&#39;and&#39; b&#39;,&#39; b&#39;able&#39; b&#39;to&#39; b&#39;eat&#39; b&#39;successful&#39;
b&#39;,&#39; b&#39;and&#39; b&#39;some&#39; b&#39;noted&#39; b&#39;only&#39; b&#39;of&#39; b&#39;a&#39; b&#39;white&#39; b&#39;fox&#39; b&#39;and&#39; b&#39;Roussillon&#39; b&#39;look&#39; b&#39;.&#39; b&#39;According&#39; b&#39;to&#39; b&#39;Kings&#39; b&#39;during&#39; b&#39;56&#39; b&#39;years&#39; b&#39;,&#39;
b&#39;\xc3\x8dmar&#39; b&#39;Mantell&#39; b&#39;listed&#39; b&#39;&quot;&#39; b&#39;religion&#39; b&#39;&quot;&#39; b&#39;that&#39; b&#39;supported&#39; b&#39;for&#39; b&#39;the&#39; b&#39;modern&#39; b&#39;nurse&#39; b&#39;difference&#39; b&#39;on&#39; b&#39;its&#39; b&#39;face&#39; b&#39;,&#39; b&#39;leaving&#39; b&#39;it&#39; b&#39;Too&#39;
b&#39;Merit&#39; b&#39;the&#39; b&#39;spots&#39; b&#39;for&#39; b&#39;a&#39; b&#39;number&#39; b&#39;of&#39; b&#39;chicks&#39; b&#39;(&#39; b&#39;Thomson&#39; b&#39;)&#39; b&#39;and&#39; b&#39;&lt;unk&gt;&#39; b&#39;(&#39; b&#39;e.g.&#39; b&#39;camel&#39; b&#39;)&#39; b&#39;.&#39; b&#39;Some&#39; b&#39;Fanny&#39;
b&#39;,&#39; b&#39;males&#39; b&#39;\xe2\x80\x94&#39; b&#39;or&#39; b&#39;small&#39; b&#39;diversity&#39; b&#39;.&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;=&#39; b&#39;=&#39; b&#39;&lt;unk&gt;&#39; b&#39;among&#39; b&#39;grey&#39; b&#39;technique&#39; b&#39;=&#39; b&#39;=&#39; b&#39;&lt;eos&gt;&#39; b&#39;&lt;eos&gt;&#39; b&#39;Naming&#39;
b&#39;statistics&#39; b&#39;include&#39; b&#39;invisible&#39; b&#39;following&#39; b&#39;Mecca&#39; b&#39;.&#39; b&#39;It&#39; b&#39;may&#39; b&#39;be&#39; b&#39;established&#39; b&#39;into&#39; b&#39;at&#39; b&#39;least&#39; b&#39;enough&#39; b&#39;alone&#39; b&#39;&lt;unk&gt;&#39; b&#39;by&#39; b&#39;their&#39; b&#39;national&#39; b&#39;non&#39;
b&#39;@-@&#39; b&#39;volume&#39; b&#39;cores&#39; b&#39;(&#39; b&#39;fulfill&#39; b&#39;@-@&#39; b&#39;bird&#39; b&#39;,&#39; b&#39;flowers&#39; b&#39;NATO&#39; b&#39;,&#39; b&#39;and&#39; b&#39;has&#39; b&#39;any&#39; b&#39;results&#39; b&#39;)&#39; b&#39;,&#39; b&#39;this&#39; b&#39;feed&#39; b&#39;on&#39;
b&#39;,&#39; b&#39;and&#39; b&#39;orchards&#39; b&#39;have&#39; b&#39;incorrect&#39; b&#39;chicks&#39; b&#39;or&#39; b&#39;structures&#39; b&#39;.&#39; b&#39;Because&#39; b&#39;part&#39; b&#39;of&#39; b&#39;these&#39; b&#39;birds&#39; b&#39;will&#39; b&#39;aimed&#39; b&#39;.&#39; b&#39;If&#39; b&#39;the&#39; b&#39;kakapo&#39;
b&#39;attain&#39; b&#39;well&#39; b&#39;allowed&#39; b&#39;,&#39; b&#39;they&#39; b&#39;are&#39; b&#39;a&#39; b&#39;&quot;&#39; b&#39;&lt;unk&gt;&#39; b&#39;form&#39; b&#39;so&#39; b&#39;since&#39; b&#39;this&#39; b&#39;name&#39; b&#39;about&#39; b&#39;,&#39; b&#39;straight&#39; b&#39;or&#39; b&#39;even&#39; b&#39;evidently&#39;
</pre></div>
</div>
<p>이 모델이 GPT-2는 아니지만, 언어의 구조를 배우기 시작한 것처럼 보입니다!</p>
<p>동적 양자화를 시연할 준비가 거의 끝났습니다. 몇 가지 helper 함수를 정의하기만 하면 됩니다:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bptt</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">eval_batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># 테스트 데이터셋 만들기</span>
<span class="k">def</span> <span class="nf">batchify</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bsz</span><span class="p">):</span>
    <span class="c1"># 데이터셋을 bsz 부분으로 얼마나 깔끔하게 나눌 수 있는지 계산합니다.</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">bsz</span>
    <span class="c1"># 깔끔하게 맞지 않는 추가적인 부분(나머지들)을 잘라냅니다.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nbatch</span> <span class="o">*</span> <span class="n">bsz</span><span class="p">)</span>
    <span class="c1"># 데이터에 대하여 bsz 배치들로 동등하게 나눕니다.</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">batchify</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">eval_batch_size</span><span class="p">)</span>

<span class="c1"># 평가 함수들</span>
<span class="k">def</span> <span class="nf">get_batch</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bptt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">seq_len</span><span class="p">]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">seq_len</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span>

<span class="k">def</span> <span class="nf">repackage_hidden</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;은닉 상태를 변화도 기록에서 제거된 새로운 tensor로 만듭니다.&quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">repackage_hidden</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="n">data_source</span><span class="p">):</span>
    <span class="c1"># Dropout을 중지시키는 평가 모드로 실행합니다.</span>
    <span class="n">model_</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">model_</span><span class="o">.</span><span class="n">init_hidden</span><span class="p">(</span><span class="n">eval_batch_size</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data_source</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bptt</span><span class="p">):</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">get_batch</span><span class="p">(</span><span class="n">data_source</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="n">model_</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="n">repackage_hidden</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
            <span class="n">output_flat</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntokens</span><span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output_flat</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h2>4. 동적 양자화 테스트하기<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>마지막으로 모델에서 <code class="docutils literal notranslate"><span class="pre">torch.quantization.quantize_dynamic</span></code> 을 호출 할 수 있습니다!
구체적으로,</p>
<ul class="simple">
<li><p>모델의 <code class="docutils literal notranslate"><span class="pre">nn.LSTM</span></code> 과 <code class="docutils literal notranslate"><span class="pre">nn.Linear</span></code> 모듈을 양자화 하도록 명시합니다.</p></li>
<li><p>가중치들이 <code class="docutils literal notranslate"><span class="pre">int8</span></code> 값으로 변환되도록 명시합니다.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch.quantization</span>

<span class="n">quantized_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="p">{</span><span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quantized_model</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>LSTMModel(
  (drop): Dropout(p=0.5, inplace=False)
  (encoder): Embedding(33278, 512)
  (rnn): DynamicQuantizedLSTM(512, 256, num_layers=5, dropout=0.5)
  (decoder): DynamicQuantizedLinear(in_features=256, out_features=33278, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
)
</pre></div>
</div>
<p>모델은 동일하게 보입니다. 이것이 어떻게 이득을 주는 것일까요? 첫째, 모델 크기가
상당히 줄어 듭니다:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_size_of_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;temp.p&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size (MB):&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="s2">&quot;temp.p&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp.p&#39;</span><span class="p">)</span>

<span class="n">print_size_of_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">print_size_of_model</span><span class="p">(</span><span class="n">quantized_model</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Size (MB): 113.94579
Size (MB): 79.739984
</pre></div>
</div>
<p>두 번째로, 평가 손실값은 같으나 추론(inference) 속도가 빨라졌습니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 메모: 양자화 된 모델은 단일 스레드로 실행되기 때문에 단일 스레드 비교를 위해</span>
<span class="c1"># 스레드 수를 1로 설정했습니다.</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_num_threads</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">time_model_evaluation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">s</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;loss: </span><span class="si">{0:.3f}</span><span class="se">\n</span><span class="s1">elapsed time (seconds): </span><span class="si">{1:.1f}</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">))</span>

<span class="n">time_model_evaluation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
<span class="n">time_model_evaluation</span><span class="p">(</span><span class="n">quantized_model</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>loss: 5.167
elapsed time (seconds): 178.6
loss: 5.168
elapsed time (seconds): 118.8
</pre></div>
</div>
<p>MacBook Pro에서 로컬로 실행하는 경우, 양자화 없이는 추론(inference)에 약 200초가 걸리고
양자화를 사용하면 약 100초가 걸립니다.</p>
</div>
<div class="section" id="id12">
<h2>마치며<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<p>동적 양자화는 정확도에 제한적인 영향을 미치면서 모델 크기를 줄이는
쉬운 방법이 될 수 있습니다.</p>
<p>읽어주셔서 감사합니다. 언제나처럼 어떠한 피드백도 환영이니, 의견이 있다면
<a class="reference external" href="https://github.com/pytorch/pytorch/issues">여기</a> 에 이슈를 남겨 주세요.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 5 minutes  4.081 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-advanced-dynamic-quantization-tutorial-py">
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../_downloads/256861ec2cab5f0dc50c523f520dfefd/dynamic_quantization_tutorial.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">dynamic_quantization_tutorial.py</span></code></a></p>
</div>
<div class="sphx-glr-download docutils container">
<p><a class="reference download internal" download="" href="../_downloads/9a0e851f5cb70c78bfde07b9bd268569/dynamic_quantization_tutorial.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">dynamic_quantization_tutorial.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.readthedocs.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


             </article>
             
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../intermediate/dynamic_quantization_bert_tutorial.html" class="btn btn-neutral float-right" title="(베타) BERT 모델 동적 양자화하기" accesskey="n" rel="next">Next <img src="../_static/images/chevron-right-orange.svg" class="next-page"></a>
      
      
        <a href="../intermediate/pruning_tutorial.html" class="btn btn-neutral" title="가지치기 기법(Pruning) 튜토리얼" accesskey="p" rel="prev"><img src="../_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  

    <hr class="helpful-hr hr-top">
      <div class="helpful-container">
        <div class="helpful-question">이 문서가 도움이 되었나요?</div>
        <div class="helpful-question yes-link" data-behavior="was-this-helpful-event" data-response="yes">네</div>
        <div class="helpful-question no-link" data-behavior="was-this-helpful-event" data-response="no">아니오</div>
        <div class="was-helpful-thank-you">피드백을 주셔서 감사합니다.</div>
      </div>
    <hr class="helpful-hr hr-bottom"/>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, PyTorch.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">(베타) LSTM 기반 단어 단위 언어 모델의 동적 양자화</a><ul>
<li><a class="reference internal" href="#id2">시작하기</a></li>
<li><a class="reference internal" href="#id5">1. 모델 정의하기</a></li>
<li><a class="reference internal" href="#id7">2. 텍스트 데이터 불러오기</a></li>
<li><a class="reference internal" href="#id9">3. 사전 학습된 모델 불러오기</a></li>
<li><a class="reference internal" href="#id11">4. 동적 양자화 테스트하기</a></li>
<li><a class="reference internal" href="#id12">마치며</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
         <script src="../_static/jquery.js"></script>
         <script src="../_static/underscore.js"></script>
         <script src="../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-71919972-3', 'auto');
  ga('send', 'pageview');

  $("[data-behavior='call-to-action-event']").on('click', function(){
    ga('send', {
      hitType: 'event',
      eventCategory: 'Download',
      eventAction: 'click',
      eventLabel: $(this).attr("data-response")
    });
   });

   $("[data-behavior='was-this-helpful-event']").on('click', function(){
    $(".helpful-question").hide();
    $(".was-helpful-thank-you").show();
    ga('send', {
      hitType: 'event',
      eventCategory: 'Was this Helpful?',
      eventAction: 'click',
      eventLabel: $(this).attr("data-response")
    });
   });

   if (location.pathname == "/") {
     $(".helpful-container").hide();
     $(".hr-bottom").hide();
   }
</script>


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-container container">
      <div class="footer-logo-wrapper"><a href="https://pytorch.kr" class="footer-logo"></a></div>
      <div class="footer-links-wrapper pb-2">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org">PyTorch 홈페이지 (공식)</a></li>
            <li><a href="https://pytorch.org">공식 홈페이지</a></li>
            <li><a href="https://pytorch.org/tutorials">공식 튜토리얼</a></li>
            <li><a href="https://pytorch.org/docs">공식 문서</a></li>
          </ul>
        </div>
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.kr">한국어 홈페이지 (비공식)</a></li>
            <li><a href="https://pytorch.kr/about" class="">사이트 소개</a></li>
            <li><a href="https://tutorials.pytorch.kr/">한국어 튜토리얼</a></li>
            <li><a href="https://github.com/9bow/PyTorch-tutorials-kr" target="_blank">한국어 튜토리얼 저장소</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.kr/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/features">Features</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li class="active">
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://pytorch.org/resources">Resources</a>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>